image: alpine/latest
packages:
  - python3
  - py3-pip
  - python3-dev
  - curl
  - wget
  - jq
  - tree
  - cmake
  - make
  - gcc
  - git
  - g++
  - musl-dev
  - libffi-dev
  - openssl-dev
  - py3-cffi
  - py3-twine
  - py3-wheel
  - py3-setuptools
  - ca-certificates
  - zlib-dev
  - xz
environment:
  PYTHONIOENCODING: utf-8
  LANG: en_US.utf-8
tasks:
  - install-poetry: |
      curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/install-poetry.py | python3 -
  - install-pkgs: |
      cd blint
      ~/.local/bin/poetry install
      wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz
      tar -xvf upx-3.96-amd64_linux.tar.xz
      cp upx-3.96-amd64_linux/upx ~/.local/bin/
  - run-lint: |
      cd blint
      ~/.local/bin/poetry run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      ~/.local/bin/poetry run flake8 . --count --exit-zero --statistics
  - run-tests: |
      cd blint
      ~/.local/bin/poetry run pytest --cov=blint tests
  - build-bins: |
      cd blint
      ~/.local/bin/poetry run pyinstaller blint/cli.py --noconfirm --log-level=WARN --nowindow --onefile --name blint --collect-all blint --upx-dir ~/.local/bin/
  - self-blint: |
      ./blint/dist/blint -i ./blint/dist/blint -o reports
      tree reports
artifacts:
  - ./blint/dist/blint
