image: ubuntu/lts
packages:
  - python3.8
  - python3-pip
  - python3-dev
  - curl
  - wget
  - jq
  - tree
  - cmake
  - make
  - gcc
  - g++
  - musl-tools
tasks:
  - install-py-pkgs: |
      python3 -m pip install twine setuptools wheel
  - install-poetry: |
      curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/install-poetry.py | python3 -
  - install-pkgs: |
      cd blint
      ~/.local/bin/poetry install
  - run-lint: |
      cd blint
      ~/.local/bin/poetry run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      ~/.local/bin/poetry run flake8 . --count --exit-zero --statistics
  - run-tests: |
      cd blint
      ~/.local/bin/poetry run pytest --cov=blint tests
  - install-sccache: |
      wget -O sccache.tar.gz --progress dot:mega https://github.com/mozilla/sccache/releases/download/v0.2.15/sccache-v0.2.15-x86_64-unknown-linux-musl.tar.gz
      tar -xvzf sccache.tar.gz
      mv sccache-*/sccache $HOME/.cargo/bin/sccache
      chmod +x $HOME/.cargo/bin/sccache
      sccache --start-server
  - install-rust-tooling: |
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -q -y
      source $HOME/.cargo/env
      rustup target add x86_64-unknown-linux-gnu
      rustup target add x86_64-unknown-linux-musl
      rustup target add x86_64-pc-windows-msvc
      rustup target add x86_64-apple-darwin
      rustup target add aarch64-apple-darwin
  - build-bins: |
      cd blint
      source $HOME/.cargo/env
      ~/.local/bin/poetry export -f requirements.txt > requirements-dist.txt
      python3 -m pip install pyoxidizer
      ~/.local/bin/pyoxidizer build --release --target-triple x86_64-unknown-linux-gnu
      ~/.local/bin/pyoxidizer build --release --target-triple x86_64-unknown-linux-musl
  - list-builds: |
      tree ./blint/build
