image: ubuntu/lts
packages:
  - python3.8
  - python3-pip
  - python3-dev
  - curl
  - wget
  - jq
  - tree
  - cmake
  - make
  - gcc
  - g++
  - musl-tools
  - language-pack-en
environment:
  PYTHONIOENCODING: utf-8
  LANG: en_US.utf-8
tasks:
  - install-py-pkgs: |
      python3 -m pip install twine setuptools wheel
  - install-poetry: |
      curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/install-poetry.py | python3 -
  - install-pkgs: |
      cd blint
      ~/.local/bin/poetry install
  - run-lint: |
      cd blint
      ~/.local/bin/poetry run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      ~/.local/bin/poetry run flake8 . --count --exit-zero --statistics
  - run-tests: |
      cd blint
      ~/.local/bin/poetry run pytest --cov=blint tests
  - install-rust-tooling: |
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -q -y
      source $HOME/.cargo/env
      rustup target add x86_64-unknown-linux-gnu
  - build-bins: |
      cd blint
      source $HOME/.cargo/env
      ~/.local/bin/poetry export -f requirements.txt > requirements-dist.txt
      python3 -m pip install pyoxidizer
      ~/.local/bin/pyoxidizer build --release --target-triple x86_64-unknown-linux-gnu
  - self-blint: |
      ./blint/build/x86_64-unknown-linux-gnu/release/install/blint -i ./blint/build/x86_64-unknown-linux-gnu/release/install/blint -o reports
      tree reports
  - pkg-builds: |
      cd ./blint/build/x86_64-unknown-linux-gnu/release/install
      tar -cvzf $HOME/blint-linux-gnu.tar.gz .
artifacts:
  - ./blint-linux-gnu.tar.gz
